<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thread Management Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        input[type="text"] {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 300px;
        }
    </style>
</head>
<body>
    <h1>Thread Management Test</h1>
    
    <div class="test-section">
        <h3>Manual API Test</h3>
        <input type="text" id="messageInput" placeholder="Enter test message" value="Hello, this is a test message">
        <button onclick="sendTestMessage()">Send Message</button>
        <button onclick="sendFollowupMessage()">Send Follow-up</button>
        <button onclick="clearLog()">Clear Log</button>
        <div id="apiLog" class="log"></div>
    </div>

    <div class="test-section">
        <h3>Widget Test</h3>
        <p>The chatbot widget should appear in the bottom-right corner. Test the following:</p>
        <ol>
            <li>Send a message and note the thread ID in the console</li>
            <li>Send another message - it should use the same thread ID</li>
            <li>Click "New" to start a new conversation - should get a new thread ID</li>
            <li>Check "History" to see previous conversations from database</li>
        </ol>
    </div>

    <script>
        // Configure the chatbot widget
        window.ChatbotWidgetConfig = {
            apiUrl: 'http://localhost:3000/api/chat',
            primaryColor: '#4F46E5',
            position: 'bottom-right',
            welcomeMessage: 'Hello! This is a test of thread management.',
            title: 'Thread Test Bot'
        };

        let currentThreadId = null;
        let testMessageCount = 0;

        function log(message) {
            const logElement = document.getElementById('apiLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('apiLog').textContent = '';
        }

        async function sendTestMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                log('ERROR: Please enter a message');
                return;
            }

            testMessageCount++;
            log(`Sending message ${testMessageCount}: "${message}"`);
            
            try {
                const requestBody = {
                    message: message,
                    history: []
                };

                // Include threadId if we have one
                if (currentThreadId) {
                    requestBody.threadId = currentThreadId;
                    log(`Using existing thread ID: ${currentThreadId}`);
                } else {
                    log('No thread ID - expecting new thread to be created');
                }

                const response = await fetch('http://localhost:3000/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                log(`Response received:`);
                log(`  - Message: "${data.message}"`);
                log(`  - Thread ID: ${data.threadId}`);
                log(`  - Conversation ID: ${data.conversationId}`);
                
                // Store thread ID for next message
                if (data.threadId) {
                    if (currentThreadId && currentThreadId !== data.threadId) {
                        log(`WARNING: Thread ID changed! Old: ${currentThreadId}, New: ${data.threadId}`);
                    }
                    currentThreadId = data.threadId;
                } else {
                    log('WARNING: No thread ID in response');
                }
                
                log('---');

            } catch (error) {
                log(`ERROR: ${error.message}`);
            }
        }

        async function sendFollowupMessage() {
            if (!currentThreadId) {
                log('ERROR: No thread ID available. Send a message first.');
                return;
            }

            const followupMessages = [
                'Can you remember what I just said?',
                'What was my previous message?',
                'Continue our conversation',
                'Tell me more about that'
            ];

            const message = followupMessages[Math.floor(Math.random() * followupMessages.length)];
            document.getElementById('messageInput').value = message;
            await sendTestMessage();
        }

        // Log when the page loads
        log('Thread Management Test initialized');
        log('Make sure the backend server is running on http://localhost:3000');
        log('---');
    </script>

    <!-- Load the chatbot widget -->
    <script src="chatbot.js"></script>
</body>
</html>
